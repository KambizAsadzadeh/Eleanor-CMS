/**	Eleanor CMS © 2014	http://eleanor-cms.ru	info@eleanor-cms.ru*/$.event.props.push("dataTransfer");function Miniature(id,maxsize,ajax){	var file=$("#"+id+" :file"),		type=$("#"+id+" [name$='[type]']"),		src=$("#"+id+" [name$='[src]']"),		image=$("#"+id+" img"),		view=$("#"+id+" .bcont:first"),//Режим просмотра		load=$("#"+id+" .bcont:last"),//Режим загрузки		reader=new FileReader(),		w8_upload,		BlockForm=function()		{			CORE.ShowLoading();			file.closest("form").off("."+id).on("submit."+id,function(e){				if(!confirm(CORE.Lang("miniature_submit")))					e.preventDefault();				else					$(this).off(e);			});		},		UnBlockForm=function()		{			CORE.HideLoading();			file.closest("form").off("."+id);		},		Upload=function(local_file){			if(!local_file.name.match(/\.(jpe?g|gif|png)$/))				return alert(CORE.Lang("miniature_only_images"));			if(local_file.size>maxsize)				return alert(CORE.Lang("miniature_maxsize",[maxsize]));			CORE.ShowLoading();			w8_upload=local_file;			reader.readAsDataURL(w8_upload);		},		Hide=function(){			view.hide();			load.show();			w8_upload=null,			type.add(src).add(file).val("").prop("disabled",false);		},		Show=function(){			load.hide();			view.show();		};	image.on("error",function(){		if(image.attr("src"))			image.attr("src","");		else		{			UnBlockForm();			Hide();		}	}).load(function(){		if(image.data("empty"))			image.data("empty",false).attr("src","");		else if(w8_upload)		{			var data=new FormData();			data.append(id,w8_upload);			CORE.Ajax(ajax||location.href,data,function(r){				w8_upload=null;				image.attr("src",r.http+"?"+Math.random()).parent().attr("href", r.http);				src.val(r.src);				type.val("upload").add(src).prop("disabled",false);			});		}		else		{			UnBlockForm();			Show();		}	});	reader.onload=function(e) {		image.attr("src",e.target.result).parent().attr("href",e.target.result);	};	file.change(function(){		Upload(this.files[0]);	});	//Удаление картинки	$("#"+id+" .ib-delete").click(Hide);	//Загрузка картинки	$("#"+id+" .select-file").click(function(e){		e.preventDefault();		file.trigger("click");	});	//Прописывание ссылки	$("#"+id+" .by-link").click(function(e){		var src_=prompt(CORE.Lang("miniature_addr"));		if(src_)		{			BlockForm();			w8_upload=null;			image.attr("src",src_);			type.val("link").add(src).prop("disabled",false);			src.val(src_);		}		e.preventDefault();	});	//Подддержка перетаскивание файлов	$("#"+id+" .upl-loadframe").on("dragover",function(e){		$(this).addClass("active");		e.dataTransfer.dropEffect="move";		e.stopPropagation();		return false;	})	.on("dragleave",function(){		$(this).removeClass("active");	})	.on("drop",function(e){		$(this).removeClass("active");		Upload(e.dataTransfer.files[0]);		e.stopPropagation();		return false;	});	//Просмотрщик	$("#"+id+" a:first").fancybox();	//Галерея	var body=$("#"+id+"-gallery div.modal-body"),		cache=body.is(":empty") ? {} : {"":body.html()},		LoadGallery=function(path)		{			if(path in cache)				body.html(cache[path]);			else				CORE.Ajax(ajax||location.href,{"miniature-gallery":path},function(r){					cache[path]=r;					body.html(r);				});		};	$("#"+id+"-gallery").on("show.bs.modal",function(){		if($("div.modal-body",this).is(":empty"))			LoadGallery("");	}).find("div.modal-body")	.on("click","button",function(){		LoadGallery($(this).data("path"));	})	.on("click",".gallery-cat a",function(e){		e.preventDefault();		LoadGallery($(this).data("path"));	}).on("click",".gallery-item:not(.gallery-cat) a",function(e){		BlockForm();		w8_upload=null;		image.attr("src",$("img",this).attr("src")).parent().attr("href",$(this).attr("href"));		src.val( $(this).data("src") );		type.val("gallery").add(src).prop("disabled",false);		e.preventDefault();		$("#"+id+"-gallery").modal("hide");	});}